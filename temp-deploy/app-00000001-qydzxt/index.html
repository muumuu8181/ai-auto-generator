<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ªé™½ç³»å¤©ä½“é‹å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c2e, #1a1a3e);
            color: #ffffff;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 0;
            text-align: center;
            border-bottom: 2px solid #4a90e2;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .header p {
            color: #cccccc;
            font-size: 1.1em;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 100px);
        }

        .control-panel {
            width: 280px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #4a90e2;
        }

        .simulation-area {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #0a0a2e, #000012);
        }

        #solarSystemCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #solarSystemCanvas:active {
            cursor: grabbing;
        }

        .info-panel {
            width: 300px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #4a90e2;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-section h3 {
            color: #4a90e2;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid #4a90e2;
            padding-bottom: 5px;
        }

        .time-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        button:hover {
            background: linear-gradient(135deg, #357abd, #2968a3);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.active {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #000;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #333;
            outline: none;
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4a90e2;
            border-radius: 50%;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4a90e2;
        }

        .planet-selector select {
            width: 100%;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #4a90e2;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .info-display {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .info-label {
            color: #cccccc;
        }

        .info-value {
            color: #4a90e2;
            font-weight: bold;
        }

        .time-display {
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #4a90e2;
            font-size: 1.1em;
            color: #ffd700;
            text-align: center;
        }

        .speed-indicator {
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 15px;
            border-radius: 15px;
            border: 1px solid #4a90e2;
            font-size: 0.9em;
            color: #cccccc;
        }

        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #4a90e2;
            font-size: 0.8em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .control-panel, .info-panel {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
            
            .simulation-area {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å¤ªé™½ç³»å¤©ä½“é‹å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <p>ã‚±ãƒ—ãƒ©ãƒ¼ã®æ³•å‰‡ã«åŸºã¥ãç²¾å¯†ãªè»Œé“è¨ˆç®—ã«ã‚ˆã‚‹å¤©ä½“é‹å‹•ã®å¯è¦–åŒ–</p>
    </div>

    <div class="main-container">
        <div class="control-panel">
            <div class="control-section">
                <h3>æ™‚é–“åˆ¶å¾¡</h3>
                <div class="time-controls">
                    <div class="button-group">
                        <button id="playBtn">â–¶ å†ç”Ÿ</button>
                        <button id="pauseBtn">â¸ åœæ­¢</button>
                        <button id="resetBtn">â¹ ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div class="slider-container">
                        <label for="speedSlider">æ™‚é–“å€é€Ÿ (1ç§’ = <span id="speedDisplay">1æ—¥</span>)</label>
                        <input type="range" id="speedSlider" min="0.1" max="100" value="1" step="0.1">
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>è¡¨ç¤ºè¨­å®š</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showOrbits" checked>
                        <label for="showOrbits">è»Œé“è¡¨ç¤º</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showLabels" checked>
                        <label for="showLabels">å¤©ä½“åè¡¨ç¤º</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showTrails" checked>
                        <label for="showTrails">è»Œé“å±¥æ­´</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showStars" checked>
                        <label for="showStars">èƒŒæ™¯æ˜Ÿç©º</label>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>å¤©ä½“é¸æŠ</h3>
                <div class="planet-selector">
                    <select id="planetSelect">
                        <option value="sun">å¤ªé™½</option>
                        <option value="mercury">æ°´æ˜Ÿ</option>
                        <option value="venus">é‡‘æ˜Ÿ</option>
                        <option value="earth" selected>åœ°çƒ</option>
                        <option value="mars">ç«æ˜Ÿ</option>
                        <option value="jupiter">æœ¨æ˜Ÿ</option>
                        <option value="saturn">åœŸæ˜Ÿ</option>
                        <option value="uranus">å¤©ç‹æ˜Ÿ</option>
                        <option value="neptune">æµ·ç‹æ˜Ÿ</option>
                    </select>
                </div>
            </div>

            <div class="control-section">
                <h3>è¦–ç‚¹åˆ¶å¾¡</h3>
                <div class="button-group">
                    <button id="zoomInBtn">ğŸ”+ æ‹¡å¤§</button>
                    <button id="zoomOutBtn">ğŸ”- ç¸®å°</button>
                    <button id="centerBtn">ğŸ¯ ä¸­å¿ƒ</button>
                </div>
            </div>
        </div>

        <div class="simulation-area">
            <canvas id="solarSystemCanvas"></canvas>
            <div class="time-display" id="timeDisplay">
                2024å¹´1æœˆ1æ—¥ 00:00:00
            </div>
            <div class="speed-indicator" id="speedIndicator">
                æ™‚é–“å€é€Ÿ: 1x
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFD700;"></div>
                    <span>å¤ªé™½</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8C7853;"></div>
                    <span>æ°´æ˜Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFC649;"></div>
                    <span>é‡‘æ˜Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #6B93D6;"></div>
                    <span>åœ°çƒ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #C1440E;"></div>
                    <span>ç«æ˜Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #D8CA9D;"></div>
                    <span>æœ¨æ˜Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FAD5A5;"></div>
                    <span>åœŸæ˜Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4FD0E3;"></div>
                    <span>å¤©ç‹æ˜Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4B70DD;"></div>
                    <span>æµ·ç‹æ˜Ÿ</span>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <div class="control-section">
                <h3>é¸æŠå¤©ä½“æƒ…å ±</h3>
                <div class="info-display" id="planetInfo">
                    <div class="info-item">
                        <span class="info-label">å¤©ä½“å:</span>
                        <span class="info-value" id="planetName">åœ°çƒ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¤ªé™½ã‹ã‚‰ã®è·é›¢:</span>
                        <span class="info-value" id="planetDistance">1.00 AU</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è»Œé“é€Ÿåº¦:</span>
                        <span class="info-value" id="planetSpeed">29.8 km/s</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å…¬è»¢å‘¨æœŸ:</span>
                        <span class="info-value" id="planetPeriod">365.25 æ—¥</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è»Œé“é€²è¡Œ:</span>
                        <span class="info-value" id="planetProgress">0%</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>è»Œé“è¦ç´ </h3>
                <div class="info-display" id="orbitalElements">
                    <div class="info-item">
                        <span class="info-label">é•·åŠå¾„:</span>
                        <span class="info-value" id="semiMajorAxis">1.00 AU</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">é›¢å¿ƒç‡:</span>
                        <span class="info-value" id="eccentricity">0.017</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è»Œé“å‚¾æ–œè§’:</span>
                        <span class="info-value" id="inclination">0.0Â°</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è¿‘æ—¥ç‚¹å¼•æ•°:</span>
                        <span class="info-value" id="argumentPeriapsis">102.9Â°</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
                <div class="info-display" id="systemInfo">
                    <div class="info-item">
                        <span class="info-label">ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ:</span>
                        <span class="info-value" id="frameRate">60 FPS</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è¨ˆç®—ç²¾åº¦:</span>
                        <span class="info-value" id="accuracy">é«˜ç²¾åº¦</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è¡¨ç¤ºå¤©ä½“æ•°:</span>
                        <span class="info-value" id="bodyCount">9</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>æ•™è‚²æƒ…å ±</h3>
                <div class="info-display" id="educationInfo">
                    <div style="font-size: 0.9em; line-height: 1.4; color: #cccccc;">
                        <strong>ã‚±ãƒ—ãƒ©ãƒ¼ã®æ³•å‰‡:</strong><br>
                        1. å¤©ä½“ã¯æ¥•å††è»Œé“ã‚’æŒã¤<br>
                        2. é¢ç©é€Ÿåº¦ã¯ä¸€å®š<br>
                        3. å‘¨æœŸã®2ä¹—ã¯é•·åŠå¾„ã®3ä¹—ã«æ¯”ä¾‹
                        <br><br>
                        <strong>ç¾åœ¨ã®è¦³æ¸¬:</strong><br>
                        <span id="currentObservation">è»Œé“ã®ç¾ã—ã„èª¿å’Œã‚’è¦³å¯Ÿä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç‰©ç†å®šæ•°ã¨å¤©ä½“ãƒ‡ãƒ¼ã‚¿
        const AU = 149597870.7; // å¤©æ–‡å˜ä½ (km)
        const G = 6.67430e-11; // ä¸‡æœ‰å¼•åŠ›å®šæ•°
        const SOLAR_MASS = 1.989e30; // å¤ªé™½è³ªé‡ (kg)
        
        // å¤©ä½“ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®è»Œé“è¦ç´ ã«åŸºã¥ãï¼‰
        const celestialBodies = {
            sun: {
                name: 'å¤ªé™½',
                mass: 1.989e30,
                radius: 696340,
                color: '#FFD700',
                semiMajorAxis: 0,
                eccentricity: 0,
                inclination: 0,
                argumentPeriapsis: 0,
                longitudeAscendingNode: 0,
                meanAnomalyEpoch: 0,
                orbitalPeriod: 0
            },
            mercury: {
                name: 'æ°´æ˜Ÿ',
                mass: 3.301e23,
                radius: 2439.7,
                color: '#8C7853',
                semiMajorAxis: 0.387,
                eccentricity: 0.206,
                inclination: 7.0,
                argumentPeriapsis: 29.1,
                longitudeAscendingNode: 48.3,
                meanAnomalyEpoch: 174.8,
                orbitalPeriod: 87.97
            },
            venus: {
                name: 'é‡‘æ˜Ÿ',
                mass: 4.867e24,
                radius: 6051.8,
                color: '#FFC649',
                semiMajorAxis: 0.723,
                eccentricity: 0.007,
                inclination: 3.4,
                argumentPeriapsis: 54.9,
                longitudeAscendingNode: 76.7,
                meanAnomalyEpoch: 50.1,
                orbitalPeriod: 224.7
            },
            earth: {
                name: 'åœ°çƒ',
                mass: 5.972e24,
                radius: 6371,
                color: '#6B93D6',
                semiMajorAxis: 1.000,
                eccentricity: 0.017,
                inclination: 0.0,
                argumentPeriapsis: 102.9,
                longitudeAscendingNode: 0.0,
                meanAnomalyEpoch: 100.5,
                orbitalPeriod: 365.25
            },
            mars: {
                name: 'ç«æ˜Ÿ',
                mass: 6.417e23,
                radius: 3389.5,
                color: '#C1440E',
                semiMajorAxis: 1.524,
                eccentricity: 0.093,
                inclination: 1.9,
                argumentPeriapsis: 286.5,
                longitudeAscendingNode: 49.6,
                meanAnomalyEpoch: 19.4,
                orbitalPeriod: 686.98
            },
            jupiter: {
                name: 'æœ¨æ˜Ÿ',
                mass: 1.898e27,
                radius: 69911,
                color: '#D8CA9D',
                semiMajorAxis: 5.203,
                eccentricity: 0.049,
                inclination: 1.3,
                argumentPeriapsis: 273.9,
                longitudeAscendingNode: 100.5,
                meanAnomalyEpoch: 20.0,
                orbitalPeriod: 4331.87
            },
            saturn: {
                name: 'åœŸæ˜Ÿ',
                mass: 5.683e26,
                radius: 58232,
                color: '#FAD5A5',
                semiMajorAxis: 9.537,
                eccentricity: 0.057,
                inclination: 2.5,
                argumentPeriapsis: 339.4,
                longitudeAscendingNode: 113.7,
                meanAnomalyEpoch: 317.0,
                orbitalPeriod: 10747.2
            },
            uranus: {
                name: 'å¤©ç‹æ˜Ÿ',
                mass: 8.681e25,
                radius: 25362,
                color: '#4FD0E3',
                semiMajorAxis: 19.191,
                eccentricity: 0.046,
                inclination: 0.8,
                argumentPeriapsis: 96.5,
                longitudeAscendingNode: 74.0,
                meanAnomalyEpoch: 142.2,
                orbitalPeriod: 30589.0
            },
            neptune: {
                name: 'æµ·ç‹æ˜Ÿ',
                mass: 1.024e26,
                radius: 24622,
                color: '#4B70DD',
                semiMajorAxis: 30.069,
                eccentricity: 0.009,
                inclination: 1.8,
                argumentPeriapsis: 273.2,
                longitudeAscendingNode: 131.8,
                meanAnomalyEpoch: 256.2,
                orbitalPeriod: 59802.0
            }
        };

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let simulation = {
            isRunning: false,
            timeSpeed: 1, // 1 = 1æ—¥/ç§’
            currentTime: 0, // ã‚¨ãƒãƒƒã‚¯ã‹ã‚‰ã®æ—¥æ•°
            selectedPlanet: 'earth',
            zoom: 1,
            offsetX: 0,
            offsetY: 0,
            showOrbits: true,
            showLabels: true,
            showTrails: true,
            showStars: true,
            trails: {} // è»Œé“å±¥æ­´
        };

        // Canvasè¨­å®š
        const canvas = document.getElementById('solarSystemCanvas');
        const ctx = canvas.getContext('2d');
        let stars = [];

        // CanvasåˆæœŸåŒ–
        function initCanvas() {
            function resize() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                generateStars();
            }
            
            resize();
            window.addEventListener('resize', resize);
        }

        // èƒŒæ™¯æ˜Ÿç©ºç”Ÿæˆ
        function generateStars() {
            stars = [];
            const numStars = 200;
            
            for (let i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    brightness: Math.random() * 0.8 + 0.2,
                    size: Math.random() * 1.5 + 0.5
                });
            }
        }

        // æ•°å­¦é–¢æ•°
        function degreesToRadians(degrees) {
            return degrees * Math.PI / 180;
        }

        function radiansToDegrees(radians) {
            return radians * 180 / Math.PI;
        }

        // ã‚±ãƒ—ãƒ©ãƒ¼æ–¹ç¨‹å¼ã®è§£ï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³ãƒ»ãƒ©ãƒ•ã‚½ãƒ³æ³•ï¼‰
        function solveKeplerEquation(M, e, tolerance = 1e-6) {
            let E = M; // åˆæœŸå€¤
            
            for (let i = 0; i < 20; i++) {
                const deltaE = (E - e * Math.sin(E) - M) / (1 - e * Math.cos(E));
                E -= deltaE;
                
                if (Math.abs(deltaE) < tolerance) break;
            }
            
            return E;
        }

        // è»Œé“ä¸Šã®ä½ç½®è¨ˆç®—
        function calculateOrbitalPosition(body, time) {
            if (body.semiMajorAxis === 0) {
                return { x: 0, y: 0, z: 0 };
            }

            const a = body.semiMajorAxis;
            const e = body.eccentricity;
            const i = degreesToRadians(body.inclination);
            const omega = degreesToRadians(body.argumentPeriapsis);
            const Omega = degreesToRadians(body.longitudeAscendingNode);
            const M0 = degreesToRadians(body.meanAnomalyEpoch);
            
            // å¹³å‡è¿‘ç‚¹è§’
            const n = 2 * Math.PI / body.orbitalPeriod; // å¹³å‡æ—¥æ—¥é‹å‹•
            const M = M0 + n * time;
            
            // é›¢å¿ƒè¿‘ç‚¹è§’
            const E = solveKeplerEquation(M, e);
            
            // çœŸè¿‘ç‚¹è§’
            const nu = 2 * Math.atan2(
                Math.sqrt(1 + e) * Math.sin(E / 2),
                Math.sqrt(1 - e) * Math.cos(E / 2)
            );
            
            // å¤ªé™½ã‹ã‚‰ã®è·é›¢
            const r = a * (1 - e * Math.cos(E));
            
            // è»Œé“é¢ã§ã®ä½ç½®
            const x_orbit = r * Math.cos(nu);
            const y_orbit = r * Math.sin(nu);
            
            // 3Dç©ºé–“ã§ã®ä½ç½®ï¼ˆè»Œé“è¦ç´ ã«ã‚ˆã‚‹å›è»¢ï¼‰
            const cosOmega = Math.cos(Omega);
            const sinOmega = Math.sin(Omega);
            const cosomega = Math.cos(omega);
            const sinomega = Math.sin(omega);
            const cosi = Math.cos(i);
            const sini = Math.sin(i);
            
            const x = (cosOmega * cosomega - sinOmega * sinomega * cosi) * x_orbit +
                     (-cosOmega * sinomega - sinOmega * cosomega * cosi) * y_orbit;
            
            const y = (sinOmega * cosomega + cosOmega * sinomega * cosi) * x_orbit +
                     (-sinOmega * sinomega + cosOmega * cosomega * cosi) * y_orbit;
            
            const z = sini * sinomega * x_orbit + sini * cosomega * y_orbit;
            
            return { 
                x: x, 
                y: y, 
                z: z, 
                distance: r,
                trueAnomaly: nu,
                eccentricAnomaly: E
            };
        }

        // ç”»é¢åº§æ¨™å¤‰æ›
        function worldToScreen(x, y) {
            const scale = Math.min(canvas.width, canvas.height) * 0.03 * simulation.zoom;
            const centerX = canvas.width / 2 + simulation.offsetX;
            const centerY = canvas.height / 2 + simulation.offsetY;
            
            return {
                x: centerX + x * scale,
                y: centerY + y * scale
            };
        }

        // è»Œé“æç”»
        function drawOrbit(body) {
            if (body.semiMajorAxis === 0) return;
            
            ctx.strokeStyle = body.color + '40';
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            const numPoints = 360;
            let firstPoint = true;
            
            for (let i = 0; i <= numPoints; i++) {
                const angle = (i / numPoints) * 2 * Math.PI;
                const time = (angle / (2 * Math.PI)) * body.orbitalPeriod;
                const pos = calculateOrbitalPosition(body, time);
                const screen = worldToScreen(pos.x, pos.y);
                
                if (firstPoint) {
                    ctx.moveTo(screen.x, screen.y);
                    firstPoint = false;
                } else {
                    ctx.lineTo(screen.x, screen.y);
                }
            }
            
            ctx.stroke();
        }

        // å¤©ä½“æç”»
        function drawCelestialBody(bodyKey, body) {
            const pos = calculateOrbitalPosition(body, simulation.currentTime);
            const screen = worldToScreen(pos.x, pos.y);
            
            // å¤©ä½“ã®ã‚µã‚¤ã‚ºè¨ˆç®—
            let size;
            if (bodyKey === 'sun') {
                size = 15;
            } else if (bodyKey === 'jupiter' || bodyKey === 'saturn') {
                size = 8;
            } else {
                size = 5;
            }
            
            // å¤©ä½“æç”»
            ctx.fillStyle = body.color;
            ctx.beginPath();
            ctx.arc(screen.x, screen.y, size, 0, 2 * Math.PI);
            ctx.fill();
            
            // é¸æŠå¤©ä½“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (bodyKey === simulation.selectedPlanet) {
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(screen.x, screen.y, size + 5, 0, 2 * Math.PI);
                ctx.stroke();
            }
            
            // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
            if (simulation.showLabels) {
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(body.name, screen.x, screen.y - size - 10);
            }
            
            // è»Œé“å±¥æ­´ã®æ›´æ–°
            if (simulation.showTrails) {
                if (!simulation.trails[bodyKey]) {
                    simulation.trails[bodyKey] = [];
                }
                
                simulation.trails[bodyKey].push({ x: screen.x, y: screen.y });
                
                // å±¥æ­´ã®é•·ã•ã‚’åˆ¶é™
                if (simulation.trails[bodyKey].length > 500) {
                    simulation.trails[bodyKey].shift();
                }
                
                // è»Œé“å±¥æ­´æç”»
                if (simulation.trails[bodyKey].length > 1) {
                    ctx.strokeStyle = body.color + '80';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    
                    for (let i = 1; i < simulation.trails[bodyKey].length; i++) {
                        const point = simulation.trails[bodyKey][i];
                        if (i === 1) {
                            ctx.moveTo(point.x, point.y);
                        } else {
                            ctx.lineTo(point.x, point.y);
                        }
                    }
                    
                    ctx.stroke();
                }
            }
            
            return pos;
        }

        // èƒŒæ™¯æ˜Ÿç©ºæç”»
        function drawStars() {
            if (!simulation.showStars) return;
            
            ctx.fillStyle = '#FFFFFF';
            
            for (const star of stars) {
                ctx.globalAlpha = star.brightness;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            ctx.globalAlpha = 1.0;
        }

        // ãƒ¡ã‚¤ãƒ³æç”»é–¢æ•°
        function draw() {
            // ç”»é¢ã‚¯ãƒªã‚¢
            ctx.fillStyle = '#000012';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // èƒŒæ™¯æ˜Ÿç©º
            drawStars();
            
            // è»Œé“æç”»
            if (simulation.showOrbits) {
                for (const [bodyKey, body] of Object.entries(celestialBodies)) {
                    drawOrbit(body);
                }
            }
            
            // å¤©ä½“æç”»
            let selectedBodyPos = null;
            
            for (const [bodyKey, body] of Object.entries(celestialBodies)) {
                const pos = drawCelestialBody(bodyKey, body);
                if (bodyKey === simulation.selectedPlanet) {
                    selectedBodyPos = pos;
                }
            }
            
            // æƒ…å ±æ›´æ–°
            updateInformation(selectedBodyPos);
        }

        // æƒ…å ±ãƒ‘ãƒãƒ«æ›´æ–°
        function updateInformation(selectedBodyPos) {
            const selectedBody = celestialBodies[simulation.selectedPlanet];
            
            if (selectedBodyPos && selectedBody) {
                document.getElementById('planetName').textContent = selectedBody.name;
                document.getElementById('planetDistance').textContent = 
                    selectedBodyPos.distance ? selectedBodyPos.distance.toFixed(3) + ' AU' : '0.000 AU';
                
                // è»Œé“é€Ÿåº¦è¨ˆç®— (ç°¡æ˜“ç‰ˆ)
                const speed = selectedBody.semiMajorAxis > 0 ? 
                    Math.sqrt(G * SOLAR_MASS / (selectedBodyPos.distance * AU)) / 1000 : 0;
                document.getElementById('planetSpeed').textContent = speed.toFixed(1) + ' km/s';
                
                document.getElementById('planetPeriod').textContent = selectedBody.orbitalPeriod.toFixed(1) + ' æ—¥';
                
                // è»Œé“é€²è¡Œåº¦
                const progress = selectedBody.orbitalPeriod > 0 ? 
                    ((simulation.currentTime % selectedBody.orbitalPeriod) / selectedBody.orbitalPeriod * 100) : 0;
                document.getElementById('planetProgress').textContent = progress.toFixed(1) + '%';
                
                // è»Œé“è¦ç´ 
                document.getElementById('semiMajorAxis').textContent = selectedBody.semiMajorAxis.toFixed(3) + ' AU';
                document.getElementById('eccentricity').textContent = selectedBody.eccentricity.toFixed(3);
                document.getElementById('inclination').textContent = selectedBody.inclination.toFixed(1) + 'Â°';
                document.getElementById('argumentPeriapsis').textContent = selectedBody.argumentPeriapsis.toFixed(1) + 'Â°';
            }
            
            // æ™‚é–“è¡¨ç¤º
            const date = new Date(2024, 0, 1);
            date.setDate(date.getDate() + simulation.currentTime);
            document.getElementById('timeDisplay').textContent = 
                date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP');
            
            // é€Ÿåº¦è¡¨ç¤º
            document.getElementById('speedIndicator').textContent = `æ™‚é–“å€é€Ÿ: ${simulation.timeSpeed.toFixed(1)}x`;
            
            // æ•™è‚²æƒ…å ±
            updateEducationalInfo();
        }

        // æ•™è‚²æƒ…å ±æ›´æ–°
        function updateEducationalInfo() {
            const observations = [
                'å†…æƒ‘æ˜Ÿã»ã©é«˜é€Ÿã§è»Œé“é‹å‹•ã—ã¦ã„ã‚‹',
                'æ¥•å††è»Œé“ã®é›¢å¿ƒç‡ãŒå¤©ä½“ã”ã¨ã«ç•°ãªã‚‹',
                'è»Œé“å‚¾æ–œè§’ã«ã‚ˆã‚‹3æ¬¡å…ƒçš„ãªå‹•ãã‚’è¦³å¯Ÿ',
                'ã‚±ãƒ—ãƒ©ãƒ¼ã®ç¬¬2æ³•å‰‡ï¼šé¢ç©é€Ÿåº¦ä¸€å®šã‚’ç¢ºèª',
                'å¤–æƒ‘æ˜Ÿã®é•·ã„å…¬è»¢å‘¨æœŸã‚’å®Ÿæ„Ÿ',
                'å¤ªé™½ç³»ã®èª¿å’Œçš„ãªæ§‹é€ ã‚’ç™ºè¦‹'
            ];
            
            const randomObservation = observations[Math.floor(Math.random() * observations.length)];
            document.getElementById('currentObservation').textContent = randomObservation;
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        let lastTime = 0;
        let frameCount = 0;
        let fpsTime = 0;

        function animate(currentTime) {
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // FPSè¨ˆç®—
            frameCount++;
            fpsTime += deltaTime;
            if (fpsTime >= 1000) {
                const fps = Math.round(frameCount * 1000 / fpsTime);
                document.getElementById('frameRate').textContent = fps + ' FPS';
                frameCount = 0;
                fpsTime = 0;
            }
            
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“æ›´æ–°
            if (simulation.isRunning) {
                simulation.currentTime += simulation.timeSpeed * deltaTime / 1000;
            }
            
            // æç”»
            draw();
            
            requestAnimationFrame(animate);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // æ™‚é–“åˆ¶å¾¡
            document.getElementById('playBtn').addEventListener('click', () => {
                simulation.isRunning = true;
                document.getElementById('playBtn').classList.add('active');
                document.getElementById('pauseBtn').classList.remove('active');
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                simulation.isRunning = false;
                document.getElementById('pauseBtn').classList.add('active');
                document.getElementById('playBtn').classList.remove('active');
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                simulation.currentTime = 0;
                simulation.trails = {};
                simulation.isRunning = false;
                document.getElementById('playBtn').classList.remove('active');
                document.getElementById('pauseBtn').classList.remove('active');
            });
            
            // é€Ÿåº¦åˆ¶å¾¡
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                simulation.timeSpeed = parseFloat(e.target.value);
                let speedText = '1æ—¥';
                if (simulation.timeSpeed >= 365) {
                    speedText = (simulation.timeSpeed / 365).toFixed(1) + 'å¹´';
                } else if (simulation.timeSpeed >= 30) {
                    speedText = (simulation.timeSpeed / 30).toFixed(1) + 'ãƒ¶æœˆ';
                } else {
                    speedText = simulation.timeSpeed.toFixed(1) + 'æ—¥';
                }
                document.getElementById('speedDisplay').textContent = speedText;
            });
            
            // è¡¨ç¤ºè¨­å®š
            document.getElementById('showOrbits').addEventListener('change', (e) => {
                simulation.showOrbits = e.target.checked;
            });
            
            document.getElementById('showLabels').addEventListener('change', (e) => {
                simulation.showLabels = e.target.checked;
            });
            
            document.getElementById('showTrails').addEventListener('change', (e) => {
                simulation.showTrails = e.target.checked;
                if (!e.target.checked) {
                    simulation.trails = {};
                }
            });
            
            document.getElementById('showStars').addEventListener('change', (e) => {
                simulation.showStars = e.target.checked;
            });
            
            // å¤©ä½“é¸æŠ
            document.getElementById('planetSelect').addEventListener('change', (e) => {
                simulation.selectedPlanet = e.target.value;
            });
            
            // è¦–ç‚¹åˆ¶å¾¡
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                simulation.zoom *= 1.5;
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                simulation.zoom /= 1.5;
            });
            
            document.getElementById('centerBtn').addEventListener('click', () => {
                simulation.offsetX = 0;
                simulation.offsetY = 0;
                simulation.zoom = 1;
            });
            
            // ãƒã‚¦ã‚¹æ“ä½œ
            let isDragging = false;
            let lastMouseX, lastMouseY;
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    
                    simulation.offsetX += deltaX;
                    simulation.offsetY += deltaY;
                    
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                simulation.zoom *= zoomFactor;
            });
        }

        // åˆæœŸåŒ–
        function init() {
            initCanvas();
            setupEventListeners();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§åœæ­¢çŠ¶æ…‹
            document.getElementById('pauseBtn').classList.add('active');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            requestAnimationFrame(animate);
            
            console.log('å¤ªé™½ç³»å¤©ä½“é‹å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>