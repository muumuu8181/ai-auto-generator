<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ…‹ç³»ãƒãƒ©ãƒ³ã‚¹ãƒ»é£Ÿç‰©é€£é–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel, .info-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .simulation-area {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #444;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .parameter-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .parameter-group h4 {
            margin-bottom: 10px;
            color: #555;
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .input-group label {
            flex: 1;
            font-size: 0.9em;
            color: #666;
        }

        .input-group input {
            width: 80px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .canvas-container {
            position: relative;
            margin-bottom: 20px;
        }

        #populationChart {
            border: 2px solid #e1e5fe;
            border-radius: 10px;
            width: 100%;
            height: 400px;
            background: #fafafa;
        }

        .ecosystem-visual {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .species-card {
            background: linear-gradient(135deg, #f0f4ff, #e8f0fe);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .species-card.predator {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff0f0, #ffe8e8);
        }

        .species-card.herbivore {
            border-color: #4ecdc4;
            background: linear-gradient(135deg, #f0fffe, #e8fdfc);
        }

        .species-card.plant {
            border-color: #45b7d1;
            background: linear-gradient(135deg, #f0f9ff, #e8f4fd);
        }

        .species-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .species-count {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .species-name {
            font-size: 1.1em;
            color: #666;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .event-log {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9ff;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85em;
            border: 1px solid #e1e5fe;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #eef;
        }

        .log-entry.warning {
            color: #ff6b6b;
            font-weight: bold;
        }

        .log-entry.info {
            color: #667eea;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .environment-controls {
            margin-bottom: 20px;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .slider-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .slider-value {
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .control-panel, .info-panel {
                order: 2;
            }
            
            .simulation-area {
                order: 1;
            }
        }

        .phase-space {
            margin-top: 20px;
        }

        #phaseChart {
            border: 2px solid #e1e5fe;
            border-radius: 10px;
            width: 100%;
            height: 300px;
            background: #fafafa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¿ ç”Ÿæ…‹ç³»ãƒãƒ©ãƒ³ã‚¹ãƒ»é£Ÿç‰©é€£é–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ğŸ¦Œ</h1>
            <p>ãƒ­ãƒˆã‚«ãƒ»ãƒœãƒ«ãƒ†ãƒ©æ–¹ç¨‹å¼ã«åŸºã¥ãå‹•çš„ç”Ÿæ…‹ç³»ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</p>
        </div>

        <div class="main-grid">
            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div class="control-panel">
                <div class="section-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡</div>
                
                <div class="preset-buttons">
                    <button class="btn btn-secondary" onclick="loadPreset('balanced')">ãƒãƒ©ãƒ³ã‚¹å‹</button>
                    <button class="btn btn-secondary" onclick="loadPreset('unstable')">ä¸å®‰å®šå‹</button>
                    <button class="btn btn-secondary" onclick="loadPreset('conservation')">ä¿è­·åŒºå‹</button>
                    <button class="btn btn-secondary" onclick="loadPreset('crisis')">å±æ©Ÿå‹</button>
                </div>

                <div class="parameter-group">
                    <h4>ğŸŒ± æ¤ç‰©ï¼ˆè‰ï¼‰</h4>
                    <div class="input-group">
                        <label>åˆæœŸå€‹ä½“æ•°:</label>
                        <input type="number" id="plantsInit" value="1000" min="0" max="5000" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>æˆé•·ç‡:</label>
                        <input type="number" id="plantsGrowth" value="0.8" min="0" max="2" step="0.1" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>ç’°å¢ƒåå®¹åŠ›:</label>
                        <input type="number" id="plantsCapacity" value="2000" min="500" max="10000" onchange="updateParameters()">
                    </div>
                </div>

                <div class="parameter-group">
                    <h4>ğŸ° è‰é£Ÿå‹•ç‰©ï¼ˆã‚¦ã‚µã‚®ï¼‰</h4>
                    <div class="input-group">
                        <label>åˆæœŸå€‹ä½“æ•°:</label>
                        <input type="number" id="herbivoresInit" value="200" min="0" max="1000" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>æ•é£ŸåŠ¹ç‡:</label>
                        <input type="number" id="herbivoresEfficiency" value="0.001" min="0" max="0.01" step="0.0001" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>æ­»äº¡ç‡:</label>
                        <input type="number" id="herbivoresMortality" value="0.1" min="0" max="1" step="0.01" onchange="updateParameters()">
                    </div>
                </div>

                <div class="parameter-group">
                    <h4>ğŸº è‚‰é£Ÿå‹•ç‰©ï¼ˆã‚ªã‚ªã‚«ãƒŸï¼‰</h4>
                    <div class="input-group">
                        <label>åˆæœŸå€‹ä½“æ•°:</label>
                        <input type="number" id="predatorsInit" value="50" min="0" max="200" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>æ•é£ŸåŠ¹ç‡:</label>
                        <input type="number" id="predatorsEfficiency" value="0.002" min="0" max="0.01" step="0.0001" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>æ­»äº¡ç‡:</label>
                        <input type="number" id="predatorsMortality" value="0.2" min="0" max="1" step="0.01" onchange="updateParameters()">
                    </div>
                </div>

                <div class="environment-controls">
                    <div class="section-title">ç’°å¢ƒè¦å› </div>
                    
                    <div class="slider-group">
                        <label>å­£ç¯€å¤‰åŒ–å¼·åº¦:</label>
                        <input type="range" id="seasonalStrength" min="0" max="1" step="0.1" value="0.3" onchange="updateEnvironment()">
                        <div class="slider-value" id="seasonalValue">0.3</div>
                    </div>
                    
                    <div class="slider-group">
                        <label>ç—…æ°—ç™ºç”Ÿç‡:</label>
                        <input type="range" id="diseaseRate" min="0" max="0.1" step="0.01" value="0.02" onchange="updateEnvironment()">
                        <div class="slider-value" id="diseaseValue">0.02</div>
                    </div>
                    
                    <div class="slider-group">
                        <label>è‡ªç„¶ç½å®³é »åº¦:</label>
                        <input type="range" id="disasterFreq" min="0" max="0.05" step="0.005" value="0.01" onchange="updateEnvironment()">
                        <div class="slider-value" id="disasterValue">0.01</div>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="startSimulation()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
                    <button class="btn btn-secondary" onclick="pauseSimulation()">ä¸€æ™‚åœæ­¢</button>
                    <button class="btn btn-danger" onclick="resetSimulation()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>

            <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="simulation-area">
                <div class="ecosystem-visual">
                    <div class="species-card plant">
                        <div class="species-icon">ğŸŒ±</div>
                        <div class="species-count" id="plantsCount">1000</div>
                        <div class="species-name">æ¤ç‰©ï¼ˆè‰ï¼‰</div>
                    </div>
                    <div class="species-card herbivore">
                        <div class="species-icon">ğŸ°</div>
                        <div class="species-count" id="herbivoresCount">200</div>
                        <div class="species-name">è‰é£Ÿå‹•ç‰©</div>
                    </div>
                    <div class="species-card predator">
                        <div class="species-icon">ğŸº</div>
                        <div class="species-count" id="predatorsCount">50</div>
                        <div class="species-name">è‚‰é£Ÿå‹•ç‰©</div>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="populationChart" width="800" height="400"></canvas>
                </div>

                <div class="phase-space">
                    <h3>ç›¸ç©ºé–“ãƒ—ãƒ­ãƒƒãƒˆï¼ˆæ•é£Ÿè€…-è¢«é£Ÿè€…é–¢ä¿‚ï¼‰</h3>
                    <canvas id="phaseChart" width="800" height="300"></canvas>
                </div>
            </div>

            <!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
            <div class="info-panel">
                <div class="section-title">çµ±è¨ˆæƒ…å ±</div>
                
                <div class="stats-panel">
                    <div class="stat-card">
                        <div class="stat-value" id="totalBiomass">1250</div>
                        <div class="stat-label">ç·ãƒã‚¤ã‚ªãƒã‚¹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="biodiversityIndex">0.85</div>
                        <div class="stat-label">ç”Ÿç‰©å¤šæ§˜æ€§æŒ‡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stabilityIndex">0.72</div>
                        <div class="stat-label">å®‰å®šæ€§æŒ‡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="simulationTime">0</div>
                        <div class="stat-label">çµŒéæ™‚é–“ï¼ˆå¹´ï¼‰</div>
                    </div>
                </div>

                <div class="section-title">äººç‚ºçš„ä»‹å…¥</div>
                <button class="btn btn-secondary" onclick="triggerHunting()">ğŸ¯ ç‹©çŒŸå®Ÿæ–½</button>
                <button class="btn btn-secondary" onclick="triggerPesticide()">ğŸ§ª è¾²è–¬æ•£å¸ƒ</button>
                <button class="btn btn-secondary" onclick="triggerConservation()">ğŸ›¡ï¸ ä¿è­·åŒºè¨­å®š</button>
                <button class="btn btn-secondary" onclick="introduceInvasive()">ğŸ‘½ å¤–æ¥ç¨®å°å…¥</button>

                <div class="section-title" style="margin-top: 20px;">ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</div>
                <div class="event-log" id="eventLog">
                    <div class="log-entry info">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†</div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="exportData()">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-secondary" onclick="saveSimulation()">ğŸ’¾ çŠ¶æ…‹ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="loadSimulation()">ğŸ“‚ çŠ¶æ…‹èª­è¾¼</button>
                </div>

                <div style="margin-top: 20px; font-size: 0.8em; color: #666;">
                    <h4>ğŸ“š ç”Ÿæ…‹å­¦çš„æ¦‚å¿µ</h4>
                    <p><strong>é£Ÿç‰©é€£é–:</strong> ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æµã‚Œã‚’è¡¨ã™ç”Ÿç‰©åŒå£«ã®æ•é£Ÿé–¢ä¿‚</p>
                    <p><strong>ãƒ­ãƒˆã‚«ãƒ»ãƒœãƒ«ãƒ†ãƒ©æ–¹ç¨‹å¼:</strong> æ•é£Ÿè€…ã¨è¢«é£Ÿè€…ã®å€‹ä½“æ•°å¤‰å‹•ã‚’è¨˜è¿°ã™ã‚‹å¾®åˆ†æ–¹ç¨‹å¼</p>
                    <p><strong>ã‚­ãƒ£ãƒªãƒ³ã‚°ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£:</strong> ç’°å¢ƒãŒç¶­æŒã§ãã‚‹æœ€å¤§å€‹ä½“æ•°</p>
                    <p><strong>ç”Ÿç‰©å¤šæ§˜æ€§:</strong> ç”Ÿæ…‹ç³»ã®å¥å…¨æ€§ã‚’ç¤ºã™æŒ‡æ¨™</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let simulationRunning = false;
        let simulationWorker = null;
        let animationId = null;
        let time = 0;
        let timeStep = 0.01;
        
        // å€‹ä½“æ•°ãƒ‡ãƒ¼ã‚¿
        let populations = {
            plants: [],
            herbivores: [],
            predators: [],
            time: []
        };
        
        // ç¾åœ¨ã®å€‹ä½“æ•°
        let currentPops = {
            plants: 1000,
            herbivores: 200,
            predators: 50
        };
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        let params = {
            plantsGrowthRate: 0.8,
            plantsCapacity: 2000,
            herbivoresEfficiency: 0.001,
            herbivoresMortality: 0.1,
            predatorsEfficiency: 0.002,
            predatorsMortality: 0.2,
            seasonalStrength: 0.3,
            diseaseRate: 0.02,
            disasterFreq: 0.01
        };
        
        // Canvasè¦ç´ 
        let populationCanvas, phaseCanvas;
        let populationCtx, phaseCtx;
        
        // åˆæœŸåŒ–
        window.onload = function() {
            populationCanvas = document.getElementById('populationChart');
            phaseCanvas = document.getElementById('phaseChart');
            populationCtx = populationCanvas.getContext('2d');
            phaseCtx = phaseCanvas.getContext('2d');
            
            updateParameters();
            drawCharts();
            logEvent('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†', 'info');
        };
        
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ›´æ–°
        function updateParameters() {
            params.plantsGrowthRate = parseFloat(document.getElementById('plantsGrowth').value);
            params.plantsCapacity = parseInt(document.getElementById('plantsCapacity').value);
            params.herbivoresEfficiency = parseFloat(document.getElementById('herbivoresEfficiency').value);
            params.herbivoresMortality = parseFloat(document.getElementById('herbivoresMortality').value);
            params.predatorsEfficiency = parseFloat(document.getElementById('predatorsEfficiency').value);
            params.predatorsMortality = parseFloat(document.getElementById('predatorsMortality').value);
            
            currentPops.plants = parseInt(document.getElementById('plantsInit').value);
            currentPops.herbivores = parseInt(document.getElementById('herbivoresInit').value);
            currentPops.predators = parseInt(document.getElementById('predatorsInit').value);
            
            updateDisplay();
        }
        
        // ç’°å¢ƒè¦å› æ›´æ–°
        function updateEnvironment() {
            params.seasonalStrength = parseFloat(document.getElementById('seasonalStrength').value);
            params.diseaseRate = parseFloat(document.getElementById('diseaseRate').value);
            params.disasterFreq = parseFloat(document.getElementById('disasterFreq').value);
            
            document.getElementById('seasonalValue').textContent = params.seasonalStrength.toFixed(1);
            document.getElementById('diseaseValue').textContent = params.diseaseRate.toFixed(3);
            document.getElementById('disasterValue').textContent = params.disasterFreq.toFixed(3);
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
        function loadPreset(type) {
            switch(type) {
                case 'balanced':
                    setValues({
                        plantsInit: 1000, plantsGrowth: 0.8, plantsCapacity: 2000,
                        herbivoresInit: 200, herbivoresEfficiency: 0.001, herbivoresMortality: 0.1,
                        predatorsInit: 50, predatorsEfficiency: 0.002, predatorsMortality: 0.2
                    });
                    logEvent('ãƒãƒ©ãƒ³ã‚¹å‹ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨', 'info');
                    break;
                case 'unstable':
                    setValues({
                        plantsInit: 800, plantsGrowth: 1.2, plantsCapacity: 1500,
                        herbivoresInit: 300, herbivoresEfficiency: 0.0015, herbivoresMortality: 0.05,
                        predatorsInit: 80, predatorsEfficiency: 0.003, predatorsMortality: 0.15
                    });
                    logEvent('ä¸å®‰å®šå‹ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨', 'info');
                    break;
                case 'conservation':
                    setValues({
                        plantsInit: 1500, plantsGrowth: 0.6, plantsCapacity: 3000,
                        herbivoresInit: 250, herbivoresEfficiency: 0.0008, herbivoresMortality: 0.08,
                        predatorsInit: 40, predatorsEfficiency: 0.0015, predatorsMortality: 0.15
                    });
                    logEvent('ä¿è­·åŒºå‹ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨', 'info');
                    break;
                case 'crisis':
                    setValues({
                        plantsInit: 500, plantsGrowth: 0.4, plantsCapacity: 1000,
                        herbivoresInit: 100, herbivoresEfficiency: 0.002, herbivoresMortality: 0.2,
                        predatorsInit: 60, predatorsEfficiency: 0.004, predatorsMortality: 0.1
                    });
                    logEvent('å±æ©Ÿå‹ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨', 'warning');
                    break;
            }
            updateParameters();
        }
        
        function setValues(values) {
            Object.keys(values).forEach(key => {
                const element = document.getElementById(key);
                if(element) element.value = values[key];
            });
        }
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        function startSimulation() {
            if(simulationRunning) return;
            
            simulationRunning = true;
            logEvent('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹', 'info');
            
            // ãƒ¡ã‚¤ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
            function simulationStep() {
                if(!simulationRunning) return;
                
                // ãƒ­ãƒˆã‚«ãƒ»ãƒœãƒ«ãƒ†ãƒ©æ–¹ç¨‹å¼ã«ã‚ˆã‚‹å€‹ä½“æ•°å¤‰å‹•è¨ˆç®—
                const dt = timeStep;
                const P = currentPops.plants;
                const H = currentPops.herbivores;
                const C = currentPops.predators;
                
                // ç’°å¢ƒè¦å› è¨ˆç®—
                const seasonalEffect = 1 + params.seasonalStrength * Math.sin(time * 2 * Math.PI);
                const diseaseEffect = Math.random() < params.diseaseRate ? 0.8 : 1.0;
                const disasterEffect = Math.random() < params.disasterFreq ? 0.5 : 1.0;
                
                // å¾®åˆ†æ–¹ç¨‹å¼ï¼ˆRunge-Kuttaæ³•ã«ã‚ˆã‚‹æ•°å€¤è§£æ³•ï¼‰
                const dP_dt = params.plantsGrowthRate * P * (1 - P/params.plantsCapacity) * seasonalEffect - params.herbivoresEfficiency * P * H;
                const dH_dt = params.herbivoresEfficiency * P * H - params.herbivoresMortality * H - params.predatorsEfficiency * H * C;
                const dC_dt = params.predatorsEfficiency * H * C - params.predatorsMortality * C;
                
                // å€‹ä½“æ•°æ›´æ–°ï¼ˆéè² åˆ¶ç´„ï¼‰
                currentPops.plants = Math.max(0, P + dP_dt * dt * diseaseEffect * disasterEffect);
                currentPops.herbivores = Math.max(0, H + dH_dt * dt * diseaseEffect * disasterEffect);
                currentPops.predators = Math.max(0, C + dC_dt * dt * disasterEffect);
                
                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆé–“å¼•ãï¼‰
                if(Math.floor(time * 100) % 5 === 0) {
                    populations.time.push(time);
                    populations.plants.push(currentPops.plants);
                    populations.herbivores.push(currentPops.herbivores);
                    populations.predators.push(currentPops.predators);
                    
                    // ãƒ‡ãƒ¼ã‚¿é‡åˆ¶é™
                    if(populations.time.length > 1000) {
                        populations.time.shift();
                        populations.plants.shift();
                        populations.herbivores.shift();
                        populations.predators.shift();
                    }
                }
                
                time += dt;
                
                // çµ¶æ»…ãƒã‚§ãƒƒã‚¯
                checkExtinction();
                
                // è¡¨ç¤ºæ›´æ–°
                updateDisplay();
                drawCharts();
                
                // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ 
                animationId = requestAnimationFrame(simulationStep);
            }
            
            simulationStep();
        }
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢
        function pauseSimulation() {
            simulationRunning = false;
            if(animationId) {
                cancelAnimationFrame(animationId);
            }
            logEvent('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢', 'info');
        }
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
        function resetSimulation() {
            pauseSimulation();
            time = 0;
            populations = {
                plants: [],
                herbivores: [],
                predators: [],
                time: []
            };
            updateParameters();
            drawCharts();
            clearEventLog();
            logEvent('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ', 'info');
        }
        
        // çµ¶æ»…ãƒã‚§ãƒƒã‚¯
        function checkExtinction() {
            if(currentPops.plants < 1) {
                logEvent('âš ï¸ æ¤ç‰©ãŒçµ¶æ»…ã—ã¾ã—ãŸï¼', 'warning');
            }
            if(currentPops.herbivores < 1) {
                logEvent('âš ï¸ è‰é£Ÿå‹•ç‰©ãŒçµ¶æ»…ã—ã¾ã—ãŸï¼', 'warning');
            }
            if(currentPops.predators < 1) {
                logEvent('âš ï¸ è‚‰é£Ÿå‹•ç‰©ãŒçµ¶æ»…ã—ã¾ã—ãŸï¼', 'warning');
            }
        }
        
        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            document.getElementById('plantsCount').textContent = Math.round(currentPops.plants);
            document.getElementById('herbivoresCount').textContent = Math.round(currentPops.herbivores);
            document.getElementById('predatorsCount').textContent = Math.round(currentPops.predators);
            
            // çµ±è¨ˆè¨ˆç®—
            const totalBiomass = currentPops.plants + currentPops.herbivores * 10 + currentPops.predators * 50;
            const diversity = calculateDiversity();
            const stability = calculateStability();
            
            document.getElementById('totalBiomass').textContent = Math.round(totalBiomass);
            document.getElementById('biodiversityIndex').textContent = diversity.toFixed(2);
            document.getElementById('stabilityIndex').textContent = stability.toFixed(2);
            document.getElementById('simulationTime').textContent = time.toFixed(1);
        }
        
        // ç”Ÿç‰©å¤šæ§˜æ€§æŒ‡æ•°è¨ˆç®—ï¼ˆã‚·ãƒ£ãƒãƒ³å¤šæ§˜æ€§æŒ‡æ•°ï¼‰
        function calculateDiversity() {
            const total = currentPops.plants + currentPops.herbivores + currentPops.predators;
            if(total === 0) return 0;
            
            const p1 = currentPops.plants / total;
            const p2 = currentPops.herbivores / total;
            const p3 = currentPops.predators / total;
            
            let H = 0;
            if(p1 > 0) H -= p1 * Math.log(p1);
            if(p2 > 0) H -= p2 * Math.log(p2);
            if(p3 > 0) H -= p3 * Math.log(p3);
            
            return H / Math.log(3); // æ­£è¦åŒ–
        }
        
        // å®‰å®šæ€§æŒ‡æ•°è¨ˆç®—
        function calculateStability() {
            if(populations.plants.length < 20) return 0;
            
            const recent = populations.plants.slice(-20);
            const mean = recent.reduce((a, b) => a + b) / recent.length;
            const variance = recent.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / recent.length;
            const cv = Math.sqrt(variance) / mean;
            
            return Math.max(0, 1 - cv);
        }
        
        // ã‚°ãƒ©ãƒ•æç”»
        function drawCharts() {
            drawPopulationChart();
            drawPhaseChart();
        }
        
        // å€‹ä½“æ•°æ¨ç§»ã‚°ãƒ©ãƒ•
        function drawPopulationChart() {
            const ctx = populationCtx;
            const canvas = populationCanvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(populations.time.length < 2) return;
            
            // ã‚°ãƒ©ãƒ•é ˜åŸŸè¨­å®š
            const margin = 40;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;
            
            // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
            const maxTime = Math.max(...populations.time);
            const maxPop = Math.max(
                Math.max(...populations.plants),
                Math.max(...populations.herbivores) * 5,
                Math.max(...populations.predators) * 20
            );
            
            // è»¸æç”»
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.stroke();
            
            // ã‚°ãƒªãƒƒãƒ‰
            ctx.strokeStyle = '#f0f0f0';
            for(let i = 1; i < 10; i++) {
                const y = margin + (chartHeight * i / 10);
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(canvas.width - margin, y);
                ctx.stroke();
            }
            
            // ãƒ‡ãƒ¼ã‚¿æç”»é–¢æ•°
            function drawLine(data, color, scale = 1) {
                if(data.length < 2) return;
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for(let i = 0; i < data.length; i++) {
                    const x = margin + (populations.time[i] / maxTime) * chartWidth;
                    const y = canvas.height - margin - (data[i] * scale / maxPop) * chartHeight;
                    
                    if(i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }
            
            // å„ç¨®å€‹ä½“æ•°æç”»
            drawLine(populations.plants, '#45b7d1', 1);
            drawLine(populations.herbivores, '#4ecdc4', 5);
            drawLine(populations.predators, '#ff6b6b', 20);
            
            // å‡¡ä¾‹
            ctx.fillStyle = '#45b7d1';
            ctx.fillRect(margin + 10, margin + 10, 15, 3);
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('æ¤ç‰©', margin + 30, margin + 15);
            
            ctx.fillStyle = '#4ecdc4';
            ctx.fillRect(margin + 80, margin + 10, 15, 3);
            ctx.fillStyle = '#333';
            ctx.fillText('è‰é£Ÿå‹•ç‰©', margin + 100, margin + 15);
            
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(margin + 170, margin + 10, 15, 3);
            ctx.fillStyle = '#333';
            ctx.fillText('è‚‰é£Ÿå‹•ç‰©', margin + 190, margin + 15);
        }
        
        // ç›¸ç©ºé–“ãƒ—ãƒ­ãƒƒãƒˆ
        function drawPhaseChart() {
            const ctx = phaseCtx;
            const canvas = phaseCanvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(populations.herbivores.length < 2) return;
            
            const margin = 40;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;
            
            const maxH = Math.max(...populations.herbivores);
            const maxC = Math.max(...populations.predators);
            
            // è»¸æç”»
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.stroke();
            
            // è»Œé“æç”»
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for(let i = 0; i < populations.herbivores.length; i++) {
                const x = margin + (populations.herbivores[i] / maxH) * chartWidth;
                const y = canvas.height - margin - (populations.predators[i] / maxC) * chartHeight;
                
                if(i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // ç¾åœ¨ä½ç½®
            if(populations.herbivores.length > 0) {
                const lastIdx = populations.herbivores.length - 1;
                const x = margin + (populations.herbivores[lastIdx] / maxH) * chartWidth;
                const y = canvas.height - margin - (populations.predators[lastIdx] / maxC) * chartHeight;
                
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('è‰é£Ÿå‹•ç‰©å€‹ä½“æ•°', canvas.width / 2 - 50, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2 + 50);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('è‚‰é£Ÿå‹•ç‰©å€‹ä½“æ•°', 0, 0);
            ctx.restore();
        }
        
        // äººç‚ºçš„ä»‹å…¥æ©Ÿèƒ½
        function triggerHunting() {
            currentPops.predators *= 0.7;
            logEvent('ğŸ¯ ç‹©çŒŸå®Ÿæ–½: è‚‰é£Ÿå‹•ç‰©30%æ¸›å°‘', 'info');
        }
        
        function triggerPesticide() {
            currentPops.plants *= 0.6;
            currentPops.herbivores *= 0.8;
            logEvent('ğŸ§ª è¾²è–¬æ•£å¸ƒ: æ¤ç‰©40%ã€è‰é£Ÿå‹•ç‰©20%æ¸›å°‘', 'warning');
        }
        
        function triggerConservation() {
            params.herbivoresMortality *= 0.8;
            params.predatorsMortality *= 0.8;
            logEvent('ğŸ›¡ï¸ ä¿è­·åŒºè¨­å®š: æ­»äº¡ç‡20%ä½ä¸‹', 'info');
        }
        
        function introduceInvasive() {
            currentPops.herbivores += 100;
            params.herbivoresEfficiency *= 1.2;
            logEvent('ğŸ‘½ å¤–æ¥ç¨®å°å…¥: ç«¶äº‰æ¿€åŒ–', 'warning');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
        function logEvent(message, type = 'info') {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearEventLog() {
            document.getElementById('eventLog').innerHTML = '<div class="log-entry info">ãƒ­ã‚°ã‚¯ãƒªã‚¢</div>';
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const data = {
                time: populations.time,
                plants: populations.plants,
                herbivores: populations.herbivores,
                predators: populations.predators,
                parameters: params
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ecosystem_simulation_${new Date().toISOString().slice(0,19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            logEvent('ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'info');
        }
        
        // çŠ¶æ…‹ä¿å­˜
        function saveSimulation() {
            const state = {
                populations: populations,
                currentPops: currentPops,
                params: params,
                time: time
            };
            localStorage.setItem('ecosystemSimulation', JSON.stringify(state));
            logEvent('ğŸ’¾ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜', 'info');
        }
        
        // çŠ¶æ…‹èª­è¾¼
        function loadSimulation() {
            const saved = localStorage.getItem('ecosystemSimulation');
            if(saved) {
                const state = JSON.parse(saved);
                populations = state.populations;
                currentPops = state.currentPops;
                params = state.params;
                time = state.time;
                
                updateDisplay();
                drawCharts();
                logEvent('ğŸ“‚ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’èª­è¾¼', 'info');
            } else {
                logEvent('âŒ ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
            }
        }
    </script>
</body>
</html>