<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生態系バランス・食物連鎖シミュレーター</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel, .info-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .simulation-area {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #444;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .parameter-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .parameter-group h4 {
            margin-bottom: 10px;
            color: #555;
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .input-group label {
            flex: 1;
            font-size: 0.9em;
            color: #666;
        }

        .input-group input {
            width: 80px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .canvas-container {
            position: relative;
            margin-bottom: 20px;
        }

        #populationChart {
            border: 2px solid #e1e5fe;
            border-radius: 10px;
            width: 100%;
            height: 400px;
            background: #fafafa;
        }

        .ecosystem-visual {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .species-card {
            background: linear-gradient(135deg, #f0f4ff, #e8f0fe);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .species-card.predator {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff0f0, #ffe8e8);
        }

        .species-card.herbivore {
            border-color: #4ecdc4;
            background: linear-gradient(135deg, #f0fffe, #e8fdfc);
        }

        .species-card.plant {
            border-color: #45b7d1;
            background: linear-gradient(135deg, #f0f9ff, #e8f4fd);
        }

        .species-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .species-count {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .species-name {
            font-size: 1.1em;
            color: #666;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .event-log {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9ff;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85em;
            border: 1px solid #e1e5fe;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #eef;
        }

        .log-entry.warning {
            color: #ff6b6b;
            font-weight: bold;
        }

        .log-entry.info {
            color: #667eea;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .environment-controls {
            margin-bottom: 20px;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .slider-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .slider-value {
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .control-panel, .info-panel {
                order: 2;
            }
            
            .simulation-area {
                order: 1;
            }
        }

        .phase-space {
            margin-top: 20px;
        }

        #phaseChart {
            border: 2px solid #e1e5fe;
            border-radius: 10px;
            width: 100%;
            height: 300px;
            background: #fafafa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌿 生態系バランス・食物連鎖シミュレーター 🦌</h1>
            <p>ロトカ・ボルテラ方程式に基づく動的生態系モデリング</p>
        </div>

        <div class="main-grid">
            <!-- コントロールパネル -->
            <div class="control-panel">
                <div class="section-title">シミュレーション制御</div>
                
                <div class="preset-buttons">
                    <button class="btn btn-secondary" onclick="loadPreset('balanced')">バランス型</button>
                    <button class="btn btn-secondary" onclick="loadPreset('unstable')">不安定型</button>
                    <button class="btn btn-secondary" onclick="loadPreset('conservation')">保護区型</button>
                    <button class="btn btn-secondary" onclick="loadPreset('crisis')">危機型</button>
                </div>

                <div class="parameter-group">
                    <h4>🌱 植物（草）</h4>
                    <div class="input-group">
                        <label>初期個体数:</label>
                        <input type="number" id="plantsInit" value="1000" min="0" max="5000" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>成長率:</label>
                        <input type="number" id="plantsGrowth" value="0.8" min="0" max="2" step="0.1" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>環境収容力:</label>
                        <input type="number" id="plantsCapacity" value="2000" min="500" max="10000" onchange="updateParameters()">
                    </div>
                </div>

                <div class="parameter-group">
                    <h4>🐰 草食動物（ウサギ）</h4>
                    <div class="input-group">
                        <label>初期個体数:</label>
                        <input type="number" id="herbivoresInit" value="200" min="0" max="1000" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>捕食効率:</label>
                        <input type="number" id="herbivoresEfficiency" value="0.001" min="0" max="0.01" step="0.0001" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>死亡率:</label>
                        <input type="number" id="herbivoresMortality" value="0.1" min="0" max="1" step="0.01" onchange="updateParameters()">
                    </div>
                </div>

                <div class="parameter-group">
                    <h4>🐺 肉食動物（オオカミ）</h4>
                    <div class="input-group">
                        <label>初期個体数:</label>
                        <input type="number" id="predatorsInit" value="50" min="0" max="200" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>捕食効率:</label>
                        <input type="number" id="predatorsEfficiency" value="0.002" min="0" max="0.01" step="0.0001" onchange="updateParameters()">
                    </div>
                    <div class="input-group">
                        <label>死亡率:</label>
                        <input type="number" id="predatorsMortality" value="0.2" min="0" max="1" step="0.01" onchange="updateParameters()">
                    </div>
                </div>

                <div class="environment-controls">
                    <div class="section-title">環境要因</div>
                    
                    <div class="slider-group">
                        <label>季節変化強度:</label>
                        <input type="range" id="seasonalStrength" min="0" max="1" step="0.1" value="0.3" onchange="updateEnvironment()">
                        <div class="slider-value" id="seasonalValue">0.3</div>
                    </div>
                    
                    <div class="slider-group">
                        <label>病気発生率:</label>
                        <input type="range" id="diseaseRate" min="0" max="0.1" step="0.01" value="0.02" onchange="updateEnvironment()">
                        <div class="slider-value" id="diseaseValue">0.02</div>
                    </div>
                    
                    <div class="slider-group">
                        <label>自然災害頻度:</label>
                        <input type="range" id="disasterFreq" min="0" max="0.05" step="0.005" value="0.01" onchange="updateEnvironment()">
                        <div class="slider-value" id="disasterValue">0.01</div>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="startSimulation()">シミュレーション開始</button>
                    <button class="btn btn-secondary" onclick="pauseSimulation()">一時停止</button>
                    <button class="btn btn-danger" onclick="resetSimulation()">リセット</button>
                </div>
            </div>

            <!-- シミュレーション表示エリア -->
            <div class="simulation-area">
                <div class="ecosystem-visual">
                    <div class="species-card plant">
                        <div class="species-icon">🌱</div>
                        <div class="species-count" id="plantsCount">1000</div>
                        <div class="species-name">植物（草）</div>
                    </div>
                    <div class="species-card herbivore">
                        <div class="species-icon">🐰</div>
                        <div class="species-count" id="herbivoresCount">200</div>
                        <div class="species-name">草食動物</div>
                    </div>
                    <div class="species-card predator">
                        <div class="species-icon">🐺</div>
                        <div class="species-count" id="predatorsCount">50</div>
                        <div class="species-name">肉食動物</div>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="populationChart" width="800" height="400"></canvas>
                </div>

                <div class="phase-space">
                    <h3>相空間プロット（捕食者-被食者関係）</h3>
                    <canvas id="phaseChart" width="800" height="300"></canvas>
                </div>
            </div>

            <!-- 情報パネル -->
            <div class="info-panel">
                <div class="section-title">統計情報</div>
                
                <div class="stats-panel">
                    <div class="stat-card">
                        <div class="stat-value" id="totalBiomass">1250</div>
                        <div class="stat-label">総バイオマス</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="biodiversityIndex">0.85</div>
                        <div class="stat-label">生物多様性指数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stabilityIndex">0.72</div>
                        <div class="stat-label">安定性指数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="simulationTime">0</div>
                        <div class="stat-label">経過時間（年）</div>
                    </div>
                </div>

                <div class="section-title">人為的介入</div>
                <button class="btn btn-secondary" onclick="triggerHunting()">🎯 狩猟実施</button>
                <button class="btn btn-secondary" onclick="triggerPesticide()">🧪 農薬散布</button>
                <button class="btn btn-secondary" onclick="triggerConservation()">🛡️ 保護区設定</button>
                <button class="btn btn-secondary" onclick="introduceInvasive()">👽 外来種導入</button>

                <div class="section-title" style="margin-top: 20px;">イベントログ</div>
                <div class="event-log" id="eventLog">
                    <div class="log-entry info">システム初期化完了</div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="exportData()">📊 データエクスポート</button>
                    <button class="btn btn-secondary" onclick="saveSimulation()">💾 状態保存</button>
                    <button class="btn btn-secondary" onclick="loadSimulation()">📂 状態読込</button>
                </div>

                <div style="margin-top: 20px; font-size: 0.8em; color: #666;">
                    <h4>📚 生態学的概念</h4>
                    <p><strong>食物連鎖:</strong> エネルギーの流れを表す生物同士の捕食関係</p>
                    <p><strong>ロトカ・ボルテラ方程式:</strong> 捕食者と被食者の個体数変動を記述する微分方程式</p>
                    <p><strong>キャリングキャパシティ:</strong> 環境が維持できる最大個体数</p>
                    <p><strong>生物多様性:</strong> 生態系の健全性を示す指標</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let simulationRunning = false;
        let simulationWorker = null;
        let animationId = null;
        let time = 0;
        let timeStep = 0.01;
        
        // 個体数データ
        let populations = {
            plants: [],
            herbivores: [],
            predators: [],
            time: []
        };
        
        // 現在の個体数
        let currentPops = {
            plants: 1000,
            herbivores: 200,
            predators: 50
        };
        
        // シミュレーションパラメータ
        let params = {
            plantsGrowthRate: 0.8,
            plantsCapacity: 2000,
            herbivoresEfficiency: 0.001,
            herbivoresMortality: 0.1,
            predatorsEfficiency: 0.002,
            predatorsMortality: 0.2,
            seasonalStrength: 0.3,
            diseaseRate: 0.02,
            disasterFreq: 0.01
        };
        
        // Canvas要素
        let populationCanvas, phaseCanvas;
        let populationCtx, phaseCtx;
        
        // 初期化
        window.onload = function() {
            populationCanvas = document.getElementById('populationChart');
            phaseCanvas = document.getElementById('phaseChart');
            populationCtx = populationCanvas.getContext('2d');
            phaseCtx = phaseCanvas.getContext('2d');
            
            updateParameters();
            drawCharts();
            logEvent('シミュレーター初期化完了', 'info');
        };
        
        // パラメータ更新
        function updateParameters() {
            params.plantsGrowthRate = parseFloat(document.getElementById('plantsGrowth').value);
            params.plantsCapacity = parseInt(document.getElementById('plantsCapacity').value);
            params.herbivoresEfficiency = parseFloat(document.getElementById('herbivoresEfficiency').value);
            params.herbivoresMortality = parseFloat(document.getElementById('herbivoresMortality').value);
            params.predatorsEfficiency = parseFloat(document.getElementById('predatorsEfficiency').value);
            params.predatorsMortality = parseFloat(document.getElementById('predatorsMortality').value);
            
            currentPops.plants = parseInt(document.getElementById('plantsInit').value);
            currentPops.herbivores = parseInt(document.getElementById('herbivoresInit').value);
            currentPops.predators = parseInt(document.getElementById('predatorsInit').value);
            
            updateDisplay();
        }
        
        // 環境要因更新
        function updateEnvironment() {
            params.seasonalStrength = parseFloat(document.getElementById('seasonalStrength').value);
            params.diseaseRate = parseFloat(document.getElementById('diseaseRate').value);
            params.disasterFreq = parseFloat(document.getElementById('disasterFreq').value);
            
            document.getElementById('seasonalValue').textContent = params.seasonalStrength.toFixed(1);
            document.getElementById('diseaseValue').textContent = params.diseaseRate.toFixed(3);
            document.getElementById('disasterValue').textContent = params.disasterFreq.toFixed(3);
        }
        
        // プリセット読み込み
        function loadPreset(type) {
            switch(type) {
                case 'balanced':
                    setValues({
                        plantsInit: 1000, plantsGrowth: 0.8, plantsCapacity: 2000,
                        herbivoresInit: 200, herbivoresEfficiency: 0.001, herbivoresMortality: 0.1,
                        predatorsInit: 50, predatorsEfficiency: 0.002, predatorsMortality: 0.2
                    });
                    logEvent('バランス型プリセット適用', 'info');
                    break;
                case 'unstable':
                    setValues({
                        plantsInit: 800, plantsGrowth: 1.2, plantsCapacity: 1500,
                        herbivoresInit: 300, herbivoresEfficiency: 0.0015, herbivoresMortality: 0.05,
                        predatorsInit: 80, predatorsEfficiency: 0.003, predatorsMortality: 0.15
                    });
                    logEvent('不安定型プリセット適用', 'info');
                    break;
                case 'conservation':
                    setValues({
                        plantsInit: 1500, plantsGrowth: 0.6, plantsCapacity: 3000,
                        herbivoresInit: 250, herbivoresEfficiency: 0.0008, herbivoresMortality: 0.08,
                        predatorsInit: 40, predatorsEfficiency: 0.0015, predatorsMortality: 0.15
                    });
                    logEvent('保護区型プリセット適用', 'info');
                    break;
                case 'crisis':
                    setValues({
                        plantsInit: 500, plantsGrowth: 0.4, plantsCapacity: 1000,
                        herbivoresInit: 100, herbivoresEfficiency: 0.002, herbivoresMortality: 0.2,
                        predatorsInit: 60, predatorsEfficiency: 0.004, predatorsMortality: 0.1
                    });
                    logEvent('危機型プリセット適用', 'warning');
                    break;
            }
            updateParameters();
        }
        
        function setValues(values) {
            Object.keys(values).forEach(key => {
                const element = document.getElementById(key);
                if(element) element.value = values[key];
            });
        }
        
        // シミュレーション開始
        function startSimulation() {
            if(simulationRunning) return;
            
            simulationRunning = true;
            logEvent('シミュレーション開始', 'info');
            
            // メインシミュレーションループ
            function simulationStep() {
                if(!simulationRunning) return;
                
                // ロトカ・ボルテラ方程式による個体数変動計算
                const dt = timeStep;
                const P = currentPops.plants;
                const H = currentPops.herbivores;
                const C = currentPops.predators;
                
                // 環境要因計算
                const seasonalEffect = 1 + params.seasonalStrength * Math.sin(time * 2 * Math.PI);
                const diseaseEffect = Math.random() < params.diseaseRate ? 0.8 : 1.0;
                const disasterEffect = Math.random() < params.disasterFreq ? 0.5 : 1.0;
                
                // 微分方程式（Runge-Kutta法による数値解法）
                const dP_dt = params.plantsGrowthRate * P * (1 - P/params.plantsCapacity) * seasonalEffect - params.herbivoresEfficiency * P * H;
                const dH_dt = params.herbivoresEfficiency * P * H - params.herbivoresMortality * H - params.predatorsEfficiency * H * C;
                const dC_dt = params.predatorsEfficiency * H * C - params.predatorsMortality * C;
                
                // 個体数更新（非負制約）
                currentPops.plants = Math.max(0, P + dP_dt * dt * diseaseEffect * disasterEffect);
                currentPops.herbivores = Math.max(0, H + dH_dt * dt * diseaseEffect * disasterEffect);
                currentPops.predators = Math.max(0, C + dC_dt * dt * disasterEffect);
                
                // データ保存（間引き）
                if(Math.floor(time * 100) % 5 === 0) {
                    populations.time.push(time);
                    populations.plants.push(currentPops.plants);
                    populations.herbivores.push(currentPops.herbivores);
                    populations.predators.push(currentPops.predators);
                    
                    // データ量制限
                    if(populations.time.length > 1000) {
                        populations.time.shift();
                        populations.plants.shift();
                        populations.herbivores.shift();
                        populations.predators.shift();
                    }
                }
                
                time += dt;
                
                // 絶滅チェック
                checkExtinction();
                
                // 表示更新
                updateDisplay();
                drawCharts();
                
                // 次のフレーム
                animationId = requestAnimationFrame(simulationStep);
            }
            
            simulationStep();
        }
        
        // シミュレーション一時停止
        function pauseSimulation() {
            simulationRunning = false;
            if(animationId) {
                cancelAnimationFrame(animationId);
            }
            logEvent('シミュレーション一時停止', 'info');
        }
        
        // シミュレーションリセット
        function resetSimulation() {
            pauseSimulation();
            time = 0;
            populations = {
                plants: [],
                herbivores: [],
                predators: [],
                time: []
            };
            updateParameters();
            drawCharts();
            clearEventLog();
            logEvent('シミュレーションリセット', 'info');
        }
        
        // 絶滅チェック
        function checkExtinction() {
            if(currentPops.plants < 1) {
                logEvent('⚠️ 植物が絶滅しました！', 'warning');
            }
            if(currentPops.herbivores < 1) {
                logEvent('⚠️ 草食動物が絶滅しました！', 'warning');
            }
            if(currentPops.predators < 1) {
                logEvent('⚠️ 肉食動物が絶滅しました！', 'warning');
            }
        }
        
        // 表示更新
        function updateDisplay() {
            document.getElementById('plantsCount').textContent = Math.round(currentPops.plants);
            document.getElementById('herbivoresCount').textContent = Math.round(currentPops.herbivores);
            document.getElementById('predatorsCount').textContent = Math.round(currentPops.predators);
            
            // 統計計算
            const totalBiomass = currentPops.plants + currentPops.herbivores * 10 + currentPops.predators * 50;
            const diversity = calculateDiversity();
            const stability = calculateStability();
            
            document.getElementById('totalBiomass').textContent = Math.round(totalBiomass);
            document.getElementById('biodiversityIndex').textContent = diversity.toFixed(2);
            document.getElementById('stabilityIndex').textContent = stability.toFixed(2);
            document.getElementById('simulationTime').textContent = time.toFixed(1);
        }
        
        // 生物多様性指数計算（シャノン多様性指数）
        function calculateDiversity() {
            const total = currentPops.plants + currentPops.herbivores + currentPops.predators;
            if(total === 0) return 0;
            
            const p1 = currentPops.plants / total;
            const p2 = currentPops.herbivores / total;
            const p3 = currentPops.predators / total;
            
            let H = 0;
            if(p1 > 0) H -= p1 * Math.log(p1);
            if(p2 > 0) H -= p2 * Math.log(p2);
            if(p3 > 0) H -= p3 * Math.log(p3);
            
            return H / Math.log(3); // 正規化
        }
        
        // 安定性指数計算
        function calculateStability() {
            if(populations.plants.length < 20) return 0;
            
            const recent = populations.plants.slice(-20);
            const mean = recent.reduce((a, b) => a + b) / recent.length;
            const variance = recent.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / recent.length;
            const cv = Math.sqrt(variance) / mean;
            
            return Math.max(0, 1 - cv);
        }
        
        // グラフ描画
        function drawCharts() {
            drawPopulationChart();
            drawPhaseChart();
        }
        
        // 個体数推移グラフ
        function drawPopulationChart() {
            const ctx = populationCtx;
            const canvas = populationCanvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(populations.time.length < 2) return;
            
            // グラフ領域設定
            const margin = 40;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;
            
            // スケール計算
            const maxTime = Math.max(...populations.time);
            const maxPop = Math.max(
                Math.max(...populations.plants),
                Math.max(...populations.herbivores) * 5,
                Math.max(...populations.predators) * 20
            );
            
            // 軸描画
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.stroke();
            
            // グリッド
            ctx.strokeStyle = '#f0f0f0';
            for(let i = 1; i < 10; i++) {
                const y = margin + (chartHeight * i / 10);
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(canvas.width - margin, y);
                ctx.stroke();
            }
            
            // データ描画関数
            function drawLine(data, color, scale = 1) {
                if(data.length < 2) return;
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for(let i = 0; i < data.length; i++) {
                    const x = margin + (populations.time[i] / maxTime) * chartWidth;
                    const y = canvas.height - margin - (data[i] * scale / maxPop) * chartHeight;
                    
                    if(i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }
            
            // 各種個体数描画
            drawLine(populations.plants, '#45b7d1', 1);
            drawLine(populations.herbivores, '#4ecdc4', 5);
            drawLine(populations.predators, '#ff6b6b', 20);
            
            // 凡例
            ctx.fillStyle = '#45b7d1';
            ctx.fillRect(margin + 10, margin + 10, 15, 3);
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('植物', margin + 30, margin + 15);
            
            ctx.fillStyle = '#4ecdc4';
            ctx.fillRect(margin + 80, margin + 10, 15, 3);
            ctx.fillStyle = '#333';
            ctx.fillText('草食動物', margin + 100, margin + 15);
            
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(margin + 170, margin + 10, 15, 3);
            ctx.fillStyle = '#333';
            ctx.fillText('肉食動物', margin + 190, margin + 15);
        }
        
        // 相空間プロット
        function drawPhaseChart() {
            const ctx = phaseCtx;
            const canvas = phaseCanvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(populations.herbivores.length < 2) return;
            
            const margin = 40;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;
            
            const maxH = Math.max(...populations.herbivores);
            const maxC = Math.max(...populations.predators);
            
            // 軸描画
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.stroke();
            
            // 軌道描画
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for(let i = 0; i < populations.herbivores.length; i++) {
                const x = margin + (populations.herbivores[i] / maxH) * chartWidth;
                const y = canvas.height - margin - (populations.predators[i] / maxC) * chartHeight;
                
                if(i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // 現在位置
            if(populations.herbivores.length > 0) {
                const lastIdx = populations.herbivores.length - 1;
                const x = margin + (populations.herbivores[lastIdx] / maxH) * chartWidth;
                const y = canvas.height - margin - (populations.predators[lastIdx] / maxC) * chartHeight;
                
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // ラベル
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('草食動物個体数', canvas.width / 2 - 50, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2 + 50);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('肉食動物個体数', 0, 0);
            ctx.restore();
        }
        
        // 人為的介入機能
        function triggerHunting() {
            currentPops.predators *= 0.7;
            logEvent('🎯 狩猟実施: 肉食動物30%減少', 'info');
        }
        
        function triggerPesticide() {
            currentPops.plants *= 0.6;
            currentPops.herbivores *= 0.8;
            logEvent('🧪 農薬散布: 植物40%、草食動物20%減少', 'warning');
        }
        
        function triggerConservation() {
            params.herbivoresMortality *= 0.8;
            params.predatorsMortality *= 0.8;
            logEvent('🛡️ 保護区設定: 死亡率20%低下', 'info');
        }
        
        function introduceInvasive() {
            currentPops.herbivores += 100;
            params.herbivoresEfficiency *= 1.2;
            logEvent('👽 外来種導入: 競争激化', 'warning');
        }
        
        // イベントログ
        function logEvent(message, type = 'info') {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearEventLog() {
            document.getElementById('eventLog').innerHTML = '<div class="log-entry info">ログクリア</div>';
        }
        
        // データエクスポート
        function exportData() {
            const data = {
                time: populations.time,
                plants: populations.plants,
                herbivores: populations.herbivores,
                predators: populations.predators,
                parameters: params
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ecosystem_simulation_${new Date().toISOString().slice(0,19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            logEvent('📊 シミュレーションデータをエクスポート', 'info');
        }
        
        // 状態保存
        function saveSimulation() {
            const state = {
                populations: populations,
                currentPops: currentPops,
                params: params,
                time: time
            };
            localStorage.setItem('ecosystemSimulation', JSON.stringify(state));
            logEvent('💾 シミュレーション状態を保存', 'info');
        }
        
        // 状態読込
        function loadSimulation() {
            const saved = localStorage.getItem('ecosystemSimulation');
            if(saved) {
                const state = JSON.parse(saved);
                populations = state.populations;
                currentPops = state.currentPops;
                params = state.params;
                time = state.time;
                
                updateDisplay();
                drawCharts();
                logEvent('📂 シミュレーション状態を読込', 'info');
            } else {
                logEvent('❌ 保存された状態が見つかりません', 'warning');
            }
        }
    </script>
</body>
</html>