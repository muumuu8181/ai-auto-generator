#!/usr/bin/env node

/**
 * Inspector AI App Scanner
 * Worker‰ΩúÊàê„Ç¢„Éó„É™„ÅÆËá™ÂãïÁô∫Ë¶ã„ÉªURLÊäΩÂá∫„Éª„Éá„Éó„É≠„Ç§Áä∂ÊÖãÁ¢∫Ë™ç
 */

const fs = require('fs');
const path = require('path');

class InspectorAppScanner {
    constructor() {
        this.baseDir = path.join(__dirname, '..');
        this.tempDeployDir = path.join(this.baseDir, 'temp-deploy');
        this.publishedAppsDir = path.join(this.baseDir, 'published-apps');
        this.scanResultFile = path.join(this.baseDir, 'logs', 'app-scan-results.json');
        
        this.ensureLogDirectory();
    }

    ensureLogDirectory() {
        const logDir = path.dirname(this.scanResultFile);
        if (!fs.existsSync(logDir)) {
            fs.mkdirSync(logDir, { recursive: true });
        }
    }

    /**
     * „Ç¢„Éó„É™„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂÆåÂÖ®„Çπ„Ç≠„É£„É≥
     */
    scanAllAppDirectories() {
        console.log('üîç Inspector App Scanner: „Ç¢„Éó„É™„Éá„Ç£„É¨„ÇØ„Éà„É™„Çπ„Ç≠„É£„É≥ÈñãÂßã');
        
        const apps = [];
        
        // temp-deploy„Éá„Ç£„É¨„ÇØ„Éà„É™„Çπ„Ç≠„É£„É≥
        if (fs.existsSync(this.tempDeployDir)) {
            const tempApps = this.scanDirectory(this.tempDeployDir, 'temp-deploy');
            apps.push(...tempApps);
        }
        
        // published-apps„Éá„Ç£„É¨„ÇØ„Éà„É™„Çπ„Ç≠„É£„É≥
        if (fs.existsSync(this.publishedAppsDir)) {
            const publishedApps = this.scanDirectory(this.publishedAppsDir, 'published-apps');
            apps.push(...publishedApps);
        }
        
        console.log(`üìã Áô∫Ë¶ã„Åï„Çå„Åü„Ç¢„Éó„É™: ${apps.length}‰ª∂`);
        
        return apps;
    }

    /**
     * „Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆ„Ç¢„Éó„É™„Çπ„Ç≠„É£„É≥
     */
    scanDirectory(dirPath, type) {
        const apps = [];
        
        try {
            const entries = fs.readdirSync(dirPath, { withFileTypes: true });
            
            entries.forEach(entry => {
                if (entry.isDirectory() && entry.name.startsWith('app-')) {
                    const appData = this.analyzeAppDirectory(path.join(dirPath, entry.name), entry.name, type);
                    if (appData) {
                        apps.push(appData);
                    }
                }
            });
        } catch (error) {
            console.error(`‚ùå „Éá„Ç£„É¨„ÇØ„Éà„É™„Çπ„Ç≠„É£„É≥„Ç®„É©„Éº: ${dirPath}`, error.message);
        }
        
        return apps;
    }

    /**
     * ÂÄãÂà•„Ç¢„Éó„É™„Éá„Ç£„É¨„ÇØ„Éà„É™ÂàÜÊûê
     */
    analyzeAppDirectory(appDir, appId, type) {
        try {
            const sessionLogPath = path.join(appDir, 'session-log.json');
            const indexHtmlPath = path.join(appDir, 'index.html');
            
            const appData = {
                appId,
                type, // 'temp-deploy' or 'published-apps'
                appDir,
                sessionLogPath,
                indexHtmlPath,
                status: 'unknown',
                urls: [],
                files: [],
                features: [],
                lastModified: null,
                deploymentInfo: null,
                errors: []
            };

            // „Éï„Ç°„Ç§„É´Â≠òÂú®Á¢∫Ë™ç
            if (fs.existsSync(indexHtmlPath)) {
                appData.files.push('index.html');
                appData.status = 'files_exist';
                
                const stats = fs.statSync(indexHtmlPath);
                appData.lastModified = stats.mtime.toISOString();
            }

            // ËøΩÂä†„Éï„Ç°„Ç§„É´Á¢∫Ë™ç
            ['script.js', 'style.css', 'styles.css'].forEach(fileName => {
                const filePath = path.join(appDir, fileName);
                if (fs.existsSync(filePath)) {
                    appData.files.push(fileName);
                }
            });

            // session-log.jsonÂàÜÊûê
            if (fs.existsSync(sessionLogPath)) {
                try {
                    const sessionLog = JSON.parse(fs.readFileSync(sessionLogPath, 'utf8'));
                    
                    // URLÊäΩÂá∫
                    this.extractUrlsFromSessionLog(sessionLog, appData);
                    
                    // Ê©üËÉΩ„ÉªÊÉÖÂ†±ÊäΩÂá∫
                    this.extractAppInfoFromSessionLog(sessionLog, appData);
                    
                } catch (error) {
                    appData.errors.push(`session-log.jsonËß£Êûê„Ç®„É©„Éº: ${error.message}`);
                }
            }

            // URL„ÅÆÊé®Ê∏¨ÁîüÊàê
            this.generatePredictedUrls(appData);

            return appData;
        } catch (error) {
            console.error(`‚ùå „Ç¢„Éó„É™ÂàÜÊûê„Ç®„É©„Éº: ${appId}`, error.message);
            return null;
        }
    }

    /**
     * session-log.json„Åã„ÇâURLÊäΩÂá∫
     */
    extractUrlsFromSessionLog(sessionLog, appData) {
        // „Éë„Çø„Éº„É≥1: deployment.targetUrl
        if (sessionLog.deployment && sessionLog.deployment.targetUrl) {
            appData.urls.push({
                type: 'deployment_target',
                url: sessionLog.deployment.targetUrl,
                source: 'session-log.deployment.targetUrl'
            });
        }

        // „Éë„Çø„Éº„É≥2: deployUrl (Áõ¥Êé•)
        if (sessionLog.deployUrl) {
            appData.urls.push({
                type: 'deploy_url',
                url: sessionLog.deployUrl,
                source: 'session-log.deployUrl'
            });
        }

        // „Éë„Çø„Éº„É≥3: artifacts.urls
        if (sessionLog.artifacts && sessionLog.artifacts.urls) {
            sessionLog.artifacts.urls.forEach(url => {
                appData.urls.push({
                    type: 'artifact_url',
                    url,
                    source: 'session-log.artifacts.urls'
                });
            });
        }

        // „Éë„Çø„Éº„É≥4: ‰ªªÊÑè„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Åã„ÇâURLÊ§úÁ¥¢
        this.searchUrlsInObject(sessionLog, appData, 'session-log');
    }

    /**
     * „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂÜÖ„ÅÆURLÊ§úÁ¥¢
     */
    searchUrlsInObject(obj, appData, source, depth = 0) {
        if (depth > 5) return; // Ê∑±Â∫¶Âà∂Èôê

        for (const [key, value] of Object.entries(obj)) {
            if (typeof value === 'string' && this.isUrl(value)) {
                appData.urls.push({
                    type: 'found_in_object',
                    url: value,
                    source: `${source}.${key}`
                });
            } else if (typeof value === 'object' && value !== null) {
                this.searchUrlsInObject(value, appData, `${source}.${key}`, depth + 1);
            }
        }
    }

    /**
     * URLÂà§ÂÆö
     */
    isUrl(str) {
        try {
            const url = new URL(str);
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch {
            return false;
        }
    }

    /**
     * „Ç¢„Éó„É™ÊÉÖÂ†±ÊäΩÂá∫
     */
    extractAppInfoFromSessionLog(sessionLog, appData) {
        // „Ç¢„Éó„É™„Çø„Ç§„Éà„É´
        if (sessionLog.appTitle) {
            appData.title = sessionLog.appTitle;
        }

        // „Ç¢„Éó„É™Ë™¨Êòé
        if (sessionLog.appDescription) {
            appData.description = sessionLog.appDescription;
        }

        // Ê©üËÉΩ„É™„Çπ„Éà
        if (sessionLog.features) {
            appData.features = sessionLog.features;
        }

        // „Éá„Éó„É≠„Ç§ÊÉÖÂ†±
        if (sessionLog.deployment) {
            appData.deploymentInfo = {
                status: sessionLog.deployment.status,
                startTime: sessionLog.deployment.startTime,
                endTime: sessionLog.deployment.endTime
            };
        }

        // „Éï„Ç°„Ç§„É´ÊÉÖÂ†±
        if (sessionLog.files) {
            sessionLog.files.forEach(file => {
                if (!appData.files.includes(file)) {
                    appData.files.push(file);
                }
            });
        }
    }

    /**
     * ‰∫àÊ∏¨URLÁîüÊàê
     */
    generatePredictedUrls(appData) {
        const baseUrl = 'https://muumuu8181.github.io/published-apps';
        
        // Âü∫Êú¨ÁöÑ„Å™GitHub Pages URL
        const predictedUrl = `${baseUrl}/${appData.appId}/`;
        
        appData.urls.push({
            type: 'predicted',
            url: predictedUrl,
            source: 'pattern_prediction'
        });

        // index.html„ÇíÊòéÁ§∫ÁöÑ„Å´Âê´„ÇÄ
        appData.urls.push({
            type: 'predicted_with_index',
            url: `${predictedUrl}index.html`,
            source: 'pattern_prediction_index'
        });
    }

    /**
     * URL„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
     */
    async performUrlChecks(apps) {
        const InspectorUrlChecker = require('./inspector-url-checker.cjs');
        const urlChecker = new InspectorUrlChecker();
        
        const allUrls = [];
        const urlAppMapping = {};
        
        // ÂÖ®URL„ÇíÂèéÈõÜ
        apps.forEach(app => {
            app.urls.forEach(urlData => {
                allUrls.push(urlData.url);
                urlAppMapping[urlData.url] = {
                    appId: app.appId,
                    type: urlData.type,
                    source: urlData.source
                };
            });
        });

        // ÈáçË§áURLÈô§Âéª
        const uniqueUrls = [...new Set(allUrls)];
        
        if (uniqueUrls.length === 0) {
            console.log('‚ö†Ô∏è „ÉÅ„Çß„ÉÉ„ÇØÂØæË±°URL„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            return [];
        }

        console.log(`üîç URL Accessibility Check: ${uniqueUrls.length}‰ª∂„ÅÆURL„Çí„ÉÅ„Çß„ÉÉ„ÇØ`);
        
        // URL„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
        const urlResults = await urlChecker.checkMultipleUrls(uniqueUrls);
        
        // ÁµêÊûú„Å´„Ç¢„Éó„É™ÊÉÖÂ†±„Çí‰ªòÂä†
        urlResults.forEach(result => {
            const mapping = urlAppMapping[result.url];
            if (mapping) {
                result.appId = mapping.appId;
                result.urlType = mapping.type;
                result.urlSource = mapping.source;
            }
        });

        return urlResults;
    }

    /**
     * Áµ±Âêà„Çπ„Ç≠„É£„É≥ÔºÜ„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
     */
    async performCompleteAppScan() {
        const startTime = Date.now();
        console.log('üöÄ Inspector App Scanner: ÂÆåÂÖ®„Çπ„Ç≠„É£„É≥ÈñãÂßã');
        
        // „Ç¢„Éó„É™„Éá„Ç£„É¨„ÇØ„Éà„É™„Çπ„Ç≠„É£„É≥
        const apps = this.scanAllAppDirectories();
        
        if (apps.length === 0) {
            console.log('‚ö†Ô∏è „Ç¢„Éó„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            return { success: false, message: 'No apps found' };
        }

        // URL„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
        const urlResults = await this.performUrlChecks(apps);
        
        // ÁµêÊûúÁµ±Âêà
        const scanResult = {
            timestamp: new Date().toISOString(),
            scanId: `scan-${Date.now()}`,
            summary: {
                totalApps: apps.length,
                totalUrls: urlResults.length,
                accessibleUrls: urlResults.filter(r => r.accessible).length,
                failedUrls: urlResults.filter(r => !r.accessible).length,
                duration: Date.now() - startTime
            },
            apps,
            urlResults
        };

        // ÁµêÊûú‰øùÂ≠ò
        this.saveScanResults(scanResult);
        
        // „É¨„Éù„Éº„ÉàÁîüÊàê
        this.generateAppScanReport(scanResult);
        
        console.log(`‚úÖ Complete App Scan: ÂÆå‰∫Ü (${scanResult.summary.duration}ms)`);
        console.log(`üìä „Ç¢„Éó„É™: ${scanResult.summary.totalApps}‰ª∂, URL: ${scanResult.summary.accessibleUrls}/${scanResult.summary.totalUrls}‰ª∂Ê≠£Â∏∏`);
        
        return scanResult;
    }

    /**
     * „Çπ„Ç≠„É£„É≥ÁµêÊûú‰øùÂ≠ò
     */
    saveScanResults(scanResult) {
        try {
            let allResults = [];
            
            if (fs.existsSync(this.scanResultFile)) {
                allResults = JSON.parse(fs.readFileSync(this.scanResultFile, 'utf8'));
            }
            
            allResults.unshift(scanResult);
            allResults = allResults.slice(0, 20); // ÊúÄÊñ∞20‰ª∂‰øùÊåÅ
            
            fs.writeFileSync(this.scanResultFile, JSON.stringify(allResults, null, 2));
            console.log(`üíæ „Çπ„Ç≠„É£„É≥ÁµêÊûú‰øùÂ≠òÂÆå‰∫Ü`);
        } catch (error) {
            console.error('‚ùå „Çπ„Ç≠„É£„É≥ÁµêÊûú‰øùÂ≠ò„Ç®„É©„Éº:', error.message);
        }
    }

    /**
     * „Ç¢„Éó„É™„Çπ„Ç≠„É£„É≥„É¨„Éù„Éº„ÉàÁîüÊàê
     */
    generateAppScanReport(scanResult) {
        const reportFile = path.join(this.baseDir, 'logs', `app-scan-report-${Date.now()}.md`);
        const timestamp = new Date(scanResult.timestamp).toLocaleString('ja-JP');
        
        let report = `# üì± Inspector AI App Scan Report

**„Çπ„Ç≠„É£„É≥ÂÆüË°å**: ${timestamp}
**Âá¶ÁêÜÊôÇÈñì**: ${scanResult.summary.duration}ms

## üìä „Çπ„Ç≠„É£„É≥ÁµêÊûú„Çµ„Éû„É™„Éº

| È†ÖÁõÆ | ‰ª∂Êï∞ | „Çπ„ÉÜ„Éº„Çø„Çπ |
|------|------|------------|
| Áô∫Ë¶ã„Ç¢„Éó„É™ | ${scanResult.summary.totalApps} | üì± |
| Ê§úÂá∫URL | ${scanResult.summary.totalUrls} | üîó |
| Ê≠£Â∏∏URL | ${scanResult.summary.accessibleUrls} | ‚úÖ |
| Áï∞Â∏∏URL | ${scanResult.summary.failedUrls} | ${scanResult.summary.failedUrls > 0 ? '‚ùå' : '‚úÖ'} |

## üìã Áô∫Ë¶ã„Ç¢„Éó„É™Ë©≥Á¥∞

`;

        scanResult.apps.forEach(app => {
            const appUrls = scanResult.urlResults.filter(r => r.appId === app.appId);
            const workingUrls = appUrls.filter(r => r.accessible);
            
            report += `### üì± ${app.appId}\n\n`;
            report += `- **„Éï„Ç°„Ç§„É´**: ${app.files.join(', ')}\n`;
            if (app.title) report += `- **„Çø„Ç§„Éà„É´**: ${app.title}\n`;
            if (app.features && app.features.length > 0) {
                report += `- **Ê©üËÉΩ**: ${app.features.slice(0, 3).join(', ')}${app.features.length > 3 ? '...' : ''}\n`;
            }
            report += `- **URLÁô∫Ë¶ã**: ${app.urls.length}‰ª∂\n`;
            report += `- **Ê≠£Â∏∏URL**: ${workingUrls.length}‰ª∂\n`;
            
            if (workingUrls.length > 0) {
                report += `- **„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ**: ${workingUrls[0].url}\n`;
            }
            
            report += '\n';
        });

        if (scanResult.summary.failedUrls > 0) {
            report += `## üö® „Ç¢„ÇØ„Çª„Çπ‰∏çÂèØURL\n\n`;
            const failedUrls = scanResult.urlResults.filter(r => !r.accessible);
            
            failedUrls.forEach(result => {
                report += `- **${result.appId}**: ${result.url} (${result.status || 'ERROR'})\n`;
            });
        }

        fs.writeFileSync(reportFile, report);
        console.log(`üìÑ „Çπ„Ç≠„É£„É≥„É¨„Éù„Éº„ÉàÁîüÊàê: ${path.basename(reportFile)}`);
    }
}

// CLIÂÆüË°åÈÉ®ÂàÜ
if (require.main === module) {
    const appScanner = new InspectorAppScanner();
    
    const command = process.argv[2];
    
    switch (command) {
        case 'scan':
            appScanner.performCompleteAppScan().then(result => {
                if (result.success !== false) {
                    console.log('\nüìä ÂÆåÂÖ®„Çπ„Ç≠„É£„É≥ÊàêÂäü');
                    console.log(`üì± „Ç¢„Éó„É™: ${result.summary.totalApps}‰ª∂`);
                    console.log(`‚úÖ Ê≠£Â∏∏URL: ${result.summary.accessibleUrls}‰ª∂`);
                    console.log(`‚ùå Áï∞Â∏∏URL: ${result.summary.failedUrls}‰ª∂`);
                }
            });
            break;
        case 'list':
            const apps = appScanner.scanAllAppDirectories();
            console.log('\nüì± Áô∫Ë¶ã„Åï„Çå„Åü„Ç¢„Éó„É™:');
            apps.forEach(app => {
                console.log(`  ${app.appId}: ${app.files.length}„Éï„Ç°„Ç§„É´, ${app.urls.length}URL`);
            });
            break;
        default:
            console.log(`
üì± Inspector App Scanner

‰ΩøÁî®ÊñπÊ≥ï:
  node inspector-app-scanner.cjs scan     # ÂÆåÂÖ®„Çπ„Ç≠„É£„É≥ÂÆüË°å
  node inspector-app-scanner.cjs list     # „Ç¢„Éó„É™‰∏ÄË¶ßË°®Á§∫
            `);
    }
}

module.exports = InspectorAppScanner;